# test.py

from groqchat_lib import GroqChat

# === 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
API_KEY = "defvwer4tgdergrtgh"  # ‚Üê –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô –ö–õ–Æ–ß!

print("=== üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GroqChat ===")
chat = GroqChat(
    api_key=API_KEY,
    log_level=20,  # INFO
    sessions_dir="test_sessions"
)
print("‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.\n")



# === 2. –†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏ ===
print("=== üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ ===")
chat.new_session("—Ç–µ—Å—Ç–æ–≤–∞—è_—Å–µ—Å—Å–∏—è")
print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–µ—Å—Å–∏—è: {chat.current_session_name}")
print(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Å—Å–∏–∏: {chat.list_sessions()}\n")

# === 3. –û–±—ã—á–Ω—ã–π —á–∞—Ç —Å –∏—Å—Ç–æ—Ä–∏–µ–π ===
print("=== üí¨ –û–±—ã—á–Ω—ã–π —á–∞—Ç (—Å –∏—Å—Ç–æ—Ä–∏–µ–π) ===")
resp1 = chat.get_answer("–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?")
print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\n–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: {resp1[:100]}...\n")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ Llama/Groq

resp2 = chat.get_answer("–ß—Ç–æ —è —Å–ø—Ä–æ—Å–∏–ª –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑?")
print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ß—Ç–æ —è —Å–ø—Ä–æ—Å–∏–ª –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑?\n–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: {resp2[:100]}...\n")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: "–í—ã —Å–ø—Ä–æ—Å–∏–ª–∏, –∫–∞–∫ –º–µ–Ω—è –∑–æ–≤—É—Ç"

resp3 = chat.get_answer("–†–∞–Ω–µ–µ —è —Å–ø—Ä–æ—Å–∏–ª: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?'. –ß—Ç–æ —Ç—ã –º–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞?")
print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –†–∞–Ω–µ–µ —è —Å–ø—Ä–æ—Å–∏–ª: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?'. –ß—Ç–æ —Ç—ã –º–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞?\n–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: {resp3[:100]}...\n")

# === 4. RAG –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º) ===
print("=== üîç RAG –∏–∑ —Ç–µ–∫—Å—Ç–∞ (strict=True) ===")
source_text = "–ì–∏–ø–ø–æ–∫—Ä–∞—Ç —Ä–æ–¥–∏–ª—Å—è –æ–∫–æ–ª–æ 460 –≥. –¥–æ –Ω.—ç. –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ –ö–æ—Å."
rag_resp1 = chat.rag_query_from_text(
    prompt="–ö–æ–≥–¥–∞ —Ä–æ–¥–∏–ª—Å—è –ì–∏–ø–ø–æ–∫—Ä–∞—Ç?",
    source_text=source_text,
    strict_context=True
)
print(f"RAG (strict): {rag_resp1}")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: "–ì–∏–ø–ø–æ–∫—Ä–∞—Ç —Ä–æ–¥–∏–ª—Å—è –æ–∫–æ–ª–æ 460 –≥. –¥–æ –Ω.—ç."

rag_resp2 = chat.rag_query_from_text(
    prompt="–ì–¥–µ –ø–æ—Ö–æ—Ä–æ–Ω–µ–Ω –ì–∏–ø–ø–æ–∫—Ä–∞—Ç?",
    source_text=source_text,
    strict_context=True
)
print(f"RAG (strict, –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö): {rag_resp2}\n")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: "–Ø –Ω–µ –∑–Ω–∞—é" –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ

# === 5. RAG –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–Ω–µ—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º) ===
print("=== üåê RAG –∏–∑ —Ç–µ–∫—Å—Ç–∞ (strict=False) ===")
rag_resp3 = chat.rag_query_from_text(
    prompt="–ì–¥–µ –ø–æ—Ö–æ—Ä–æ–Ω–µ–Ω –ì–∏–ø–ø–æ–∫—Ä–∞—Ç?",
    source_text=source_text,
    strict_context=False
)
print(f"RAG (non-strict): {rag_resp3}\n")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –∏–∑ —Å–≤–æ–∏—Ö –∑–Ω–∞–Ω–∏–π

# === 6. RAG –∏–∑ —Ñ–∞–π–ª–∞ ===
print("=== üìé RAG –∏–∑ —Ñ–∞–π–ª–∞ ===")
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª test_document.txt —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ!
rag_file_resp = chat.rag_query_from_file(
    prompt="–ö–∞–∫–æ–π –Ω–æ–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞?",
    file_path="test_document.txt",
    strict_context=True
)
print(f"RAG –∏–∑ —Ñ–∞–π–ª–∞: {rag_file_resp}\n")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: "–ù–æ–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ GRQ-2026"

# === 7. –ê—É–¥–∏—Ç-–ª–æ–≥ ===
print("=== üìú –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É–¥–∏—Ç-–ª–æ–≥–∞ ===")
import json
audit_path = "test_sessions/—Ç–µ—Å—Ç–æ–≤–∞—è_—Å–µ—Å—Å–∏—è_audit.json"
with open(audit_path, "r", encoding="utf-8") as f:
    audit_log = json.load(f)
print(f"–ó–∞–ø–∏—Å–µ–π –≤ –∞—É–¥–∏—Ç–µ: {len(audit_log)}")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: >=5 (2 —á–∞—Ç–∞ + 3 RAG)
print(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ: {audit_log[-1]['event_type']}\n")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: "rag_query"

# === 8. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π ===
print("=== ü§ñ –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π Groq ===")
models = chat.fetch_available_models(save_to="test_models.json")
print(f"–î–æ—Å—Ç—É–ø–Ω–æ –º–æ–¥–µ–ª–µ–π: {len(models)}")  # –û–∂–∏–¥–∞–µ—Ç—Å—è: >=3
for m in models[:2]:
    print(f"- {m['id']} (–∫–æ–Ω—Ç–µ–∫—Å—Ç: {m['context_window']})")
print("\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É test_sessions –∏ —Ñ–∞–π–ª test_models.json.")